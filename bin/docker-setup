#!/usr/bin/env ruby
require 'fileutils'
include FileUtils

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)

def system!(*args)
  system(*args) || abort("\n==== Command #{args} failed ====")
end

chdir APP_ROOT do
  # This script is a starting point to setup your application.

  puts '==== Docker setup ===='
  #This works if docker and docker-compose are installed:
  system 'if [[ $(which docker) && $(docker --version) ]] && [[ $(which docker-compose) && $(docker-compose --version) ]]; then
           echo "docker and docker-compose available!"
          fi'

  system 'if [[ $(which docker) && $(docker --version) ]] && [[ $(which docker-compose) && $(docker-compose --version) ]]; then
              echo "docker and docker-compose available!"
              # commands
              docker-compose up --no-start
              sleep 5
              docker-compose run web sleep 3 && \
              echo "ℹ️  Waiting for postgres to boot..." && \
              sleep 3 && \
              bundle exec rake db:drop db:create db:migrate DISABLE_DATABASE_ENVIRONMENT_CHECK=1 RAILS_ENV=production && \
              sleep 2
              echo "ℹ️  Ignore the errors! if any!" && \
              sleep 1 && \
              echo "ℹ️  Ready to import mushrooms now!" && \
              sleep 3 && \
              bundle exec rake dataset:import && \
              sleep 1
              sleep 4
              echo "ℹ️  Removing one-off container..."
              sleep 5
              docker rm mushroomify_web_run_1
              sleep 4
              echo "ℹ️  Booting now..."
              sleep 4
              docker-compose up
            else
              echo "Too bad no docker!"
              # command
           fi'
end
